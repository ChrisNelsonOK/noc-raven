# ðŸ¦… NoC Raven - Fluent Bit Configuration
# High-performance syslog collection and forwarding
# Optimized for venue environments with thousands of devices

[SERVICE]
    Flush                   1
    Daemon                  Off
    Log_Level               info
    HTTP_Server             On
    HTTP_Listen             0.0.0.0
    HTTP_Port               2020
    Parsers_File            /opt/noc-raven/config/parsers.conf
    Storage.path            /data/fluent-bit/
    Storage.sync            normal
    Storage.checksum        off
    Storage.backlog.mem_limit 50MB
    Storage.metrics         on

# =============================================================================
# INPUT PLUGINS
# =============================================================================

# Syslog UDP Input (RFC3164 and RFC5424)
[INPUT]
    Name                    syslog
    Mode                    udp
    Listen                  0.0.0.0
    Port                    514
    Parser                  syslog-rfc3164-custom
    Buffer_Chunk_Size       32KB
    Buffer_Max_Size         2MB
    Tag                     syslog.udp
    Mem_Buf_Limit          100MB

# Syslog TCP Input (for devices that prefer TCP)
[INPUT]
    Name                    syslog
    Mode                    tcp
    Listen                  0.0.0.0
    Port                    1514
    Parser                  syslog-rfc5424-custom
    Buffer_Chunk_Size       32KB
    Buffer_Max_Size         2MB
    Tag                     syslog.tcp
    Mem_Buf_Limit          100MB

# Windows Events HTTP Input (Vector fallback) - Using port 8085 to avoid Vector conflict
[INPUT]
    Name                    http
    Listen                  0.0.0.0
    Port                    8085
    Tag                     windows.events
    Buffer_Chunk_Size       1MB
    Buffer_Max_Size         5MB

# System metrics collection
[INPUT]
    Name                    cpu
    Tag                     metrics.cpu
    Interval_Sec           30

[INPUT]
    Name                    mem
    Tag                     metrics.memory
    Interval_Sec           30

[INPUT]
    Name                    disk
    Tag                     metrics.disk
    Interval_Sec           30

[INPUT]
    Name                    netif
    Tag                     metrics.network
    Interval_Sec           30
    Interface               eth0

# =============================================================================
# FILTER PLUGINS
# =============================================================================

# Parse and enrich syslog messages
[FILTER]
    Name                    parser
    Match                   syslog.*
    Key_Name                message
    Parser                  syslog-rfc3164-custom
    Parser                  syslog-rfc5424-custom
    Reserve_Data            On
    Preserve_Key            On

# Add NoC Raven metadata
[FILTER]
    Name                    modify
    Match                   *
    Add                     noc_raven.collector_id ${HOSTNAME}
    Add                     noc_raven.site_id venue-${SITE_ID:-unknown}
    Add                     noc_raven.version 1.0.0
    Add                     noc_raven.timestamp ${FLB_NOW}

# Geo-location tagging (if available)
[FILTER]
    Name                    modify
    Match                   *
    Add_if_not_present      geo.country US
    Add_if_not_present      geo.region unknown
    Add_if_not_present      geo.city unknown

# Device classification based on source IP patterns (disabled - script not available)
# [FILTER]
#     Name                    lua
#     Match                   syslog.*
#     Script                  /opt/noc-raven/config/device-classifier.lua
#     Call                    classify_device

# Rate limiting for high-volume sources
[FILTER]
    Name                    throttle
    Match                   syslog.*
    Rate                    10000
    Window                  60
    Interval                1m

# Buffer management for offline operation
[FILTER]
    Name                    modify
    Match                   *
    Add                     buffer.queued_at ${FLB_NOW}
    Add                     buffer.retention_days 14

# =============================================================================
# OUTPUT PLUGINS
# =============================================================================

# Primary output to obs.rectitude.net via VPN
[OUTPUT]
    Name                    syslog
    Match                   syslog.*
    Host                    obs.rectitude.net
    Port                    1514
    Mode                    udp
    Syslog_Format           rfc3164
    Syslog_Hostname_key     hostname
    Syslog_Appname_key      appname
    Syslog_Procid_key       procid
    Syslog_Msgid_key        msgid
    Syslog_SD_key           structured_data
    Syslog_Message_key      message
    Allow_Longer_SD_ID      true
    # Retry configuration
    Retry_Limit             5
    # Storage for offline operation
    storage.type            filesystem
    storage.total_limit_size 10GB

# Windows Events to Vector HTTP endpoint
[OUTPUT]
    Name                    http
    Match                   windows.events
    Host                    obs.rectitude.net
    Port                    8084
    URI                     /
    Format                  json
    json_date_key           timestamp
    json_date_format        iso8601
    # Retry configuration
    Retry_Limit             3
    # Storage for offline operation
    storage.type            filesystem
    storage.total_limit_size 2GB

# System metrics to InfluxDB
[OUTPUT]
    Name                    influxdb
    Match                   metrics.*
    Host                    obs.rectitude.net
    Port                    8086
    Database                r369
    HTTP_User               admin
    HTTP_Passwd             ${INFLUXDB_PASSWORD}
    Tag_Keys                host
    Sequence_Tag            seq
    # Retry configuration
    Retry_Limit             3
    # Storage for offline operation
    storage.type            filesystem
    storage.total_limit_size 1GB

# Local storage for debugging and backup
[OUTPUT]
    Name                    file
    Match                   *
    Path                    /data/syslog/backup/
    File                    noc-raven-backup.log
    Format                  json_lines
    # Rotate files daily
    Rotate_Daily            true
    # Keep 14 days of backups
    Rotate_Max_Files        14

# Health check output (for monitoring)
[OUTPUT]
    Name                    http
    Match                   metrics.cpu
    Host                    127.0.0.1
    Port                    2020
    URI                     /health
    Format                  json
    # Only send every 5 minutes
    Suppress_Type_Name      true
    workers                 1

# =============================================================================
# STORAGE CONFIGURATION
# =============================================================================

# Configure persistent storage for offline operation
# This ensures we don't lose data during VPN outages

[STORAGE]
    # Storage path
    path                   /data/fluent-bit/storage/
    
    # Synchronization mode
    sync                   normal
    
    # Enable checksums
    checksum               off
    
    # Maximum memory for backlog
    backlog.mem_limit      100MB
    
    # Storage metrics
    metrics                on

# =============================================================================
# HEALTH CHECK CONFIGURATION
# =============================================================================

# Enable health check endpoint for container orchestration
[HEALTH_CHECK]
    HC_Errors_Count        5
    HC_Retry_Failure_Count 5
    HC_Period              60
