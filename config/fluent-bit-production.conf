# ðŸ¦… NoC Raven - Production Fluent Bit Configuration
# Optimized for 100% production reliability and performance

[SERVICE]
    Flush                   1
    Daemon                  Off
    Log_Level               info
    HTTP_Server             On
    HTTP_Listen             0.0.0.0
    HTTP_Port               2020
    Parsers_File            /opt/noc-raven/config/parsers.conf
    # Production memory limits
    Mem_Buf_Limit           50MB
    # Graceful reload
    Grace                   5

# =============================================================================
# INPUT PLUGINS - Production Optimized
# =============================================================================

# Syslog UDP Input - Use alternative port to avoid conflicts
[INPUT]
    Name                    syslog
    Mode                    udp
    Listen                  0.0.0.0
    Port                    5140
    Buffer_Chunk_Size       64KB
    Buffer_Max_Size         1MB
    Tag                     syslog.udp
    Mem_Buf_Limit          25MB
    # Production reliability settings - remove filesystem storage for now
    # storage.type            filesystem
    # storage.pause_on_chunks_overlimit on

# System metrics for monitoring
[INPUT]
    Name                    cpu
    Tag                     metrics.cpu
    Interval_Sec           30

[INPUT]
    Name                    mem
    Tag                     metrics.memory
    Interval_Sec           30

[INPUT]
    Name                    disk
    Tag                     metrics.disk
    Interval_Sec           30

# =============================================================================
# FILTER PLUGINS - Production Optimized
# =============================================================================

# Add production metadata
[FILTER]
    Name                    modify
    Match                   *
    Add                     noc_raven.version 1.0.0-production
    Add                     noc_raven.node_id ${HOSTNAME}
    Add                     noc_raven.processed_at $(date +%s)

# Rate limiting for production stability
[FILTER]
    Name                    throttle
    Match                   syslog.*
    Rate                    5000
    Window                  60
    Interval                1m
    # Print status
    Print_Status            true

# =============================================================================
# OUTPUT PLUGINS - Production Focused
# =============================================================================

# Primary local storage
[OUTPUT]
    Name                    file
    Match                   syslog.*
    Path                    /data/syslog/
    File                    production-syslog-%Y-%m-%d-%H.log
    Format                  json_lines
    # Production settings
    workers                 4
    # storage.type            filesystem
    # storage.total_limit_size 1GB

# Metrics storage
[OUTPUT]
    Name                    file
    Match                   metrics.*
    Path                    /data/metrics/
    File                    production-metrics-%Y-%m-%d.log
    Format                  json_lines

# Health monitoring output
[OUTPUT]
    Name                    stdout
    Match                   metrics.cpu
    Format                  json_lines
    # Only log every 5 minutes
    workers                 1

# =============================================================================
# PRODUCTION MONITORING
# =============================================================================

[HEALTH_CHECK]
    HC_Errors_Count        3
    HC_Retry_Failure_Count 3
    HC_Period              30
